<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>masimplo's blog | Teamcity agent as Docker container</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Teamcity agent as Docker container">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/teamcity-agent-as-docker-container">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="masimplo's blog">
  <meta property="og:image" content="/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/teamcity-agent-as-docker-container">
  <meta name="twitter:title" content="Teamcity agent as Docker container">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="masimplo's blog Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/light.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="" class="header-logo" title="masimplo's blog">masimplo's blog</a>
  <ul class="header-links">
    
      <li>
        <a href="https://twitter.com/masimplo" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/masimplo" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/masimplo" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="mailto:masimplo@gmail.com" target="_blank" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Teamcity agent as Docker container</h1>
            <p></p>
            <div class="article-list-footer">
              <span class="article-list-date">
                October 16, 2016
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  2 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>Updating teamcity agents with external project dependencies (e.g. gulp cli or nodejs version) can be a pain, especially if you have many build agents that are not maintained through some tooling like puppet, ansible etc. <a href="https://www.jetbrains.com">Jetbrains</a> have recently released official docker images for both the <a href="https://www.jetbrains.com/teamcity/">TeamCity</a> server and agents. If you follow their <a href="https://hub.docker.com/r/jetbrains/teamcity-agent/">guide</a> you will see they recommend starting the vanilla image, bashing in, installing everything you need and then commit this container as your custom image. Unfortunately this cannot be versioned controlled, is hard to reproduce and even harder to remember what’s in that magical container a few days after creating.</p>

<p>In my opinion a much nicer way is to use the more established approach in the docker community of starting off with their image as a base in a Dockerfile and setting up everything inside that Dockerfile.</p>

<p>For example I wanted a build agent that could build a javascript project using gulp. Let’s take a look:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>FROM jetbrains/teamcity-agent

# Install nodejs
RUN set -ex \
  &amp;&amp; for key in \
    9554F04D7259F04124DE6B476D5A82AC7E37093B \
    94AE36675C464D64BAFA68DD7434390BDBE9B9C5 \
    0034A06D9D9B0064CE8ADF6BF1747F4AD2306D93 \
    FD3A5288F042B6850C66B31F09FE44734EB7990E \
    71DCFD284A79C3B38668286BC97EC7A07EDE3FC1 \
    DD8F2338BAE7501E3DD5AC78C273792F7D83545D \
    B9AE9905FFD7803F25714661B63B535A4C206CA9 \
    C4F0DFFF4E8C1A8236409D08E73BC641CC11F4C8 \
  ; do \
    gpg --keyserver ha.pool.sks-keyservers.net --recv-keys "$key"; \
  done

ENV NPM_CONFIG_LOGLEVEL info
ENV NODE_VERSION 6.8.1

RUN curl -SLO "https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz" \
  &amp;&amp; curl -SLO "https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc" \
  &amp;&amp; gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \
  &amp;&amp; grep " node-v$NODE_VERSION-linux-x64.tar.xz\$" SHASUMS256.txt | sha256sum -c - \
  &amp;&amp; tar -xJf "node-v$NODE_VERSION-linux-x64.tar.xz" -C /usr/local --strip-components=1 \
  &amp;&amp; rm "node-v$NODE_VERSION-linux-x64.tar.xz" SHASUMS256.txt.asc SHASUMS256.txt \
  &amp;&amp; ln -s /usr/local/bin/node /usr/local/bin/nodejs

# Install our global dependencies
RUN npm i -g gulp typings

# Set default environmental variables
ENV SERVER_URL="http://teamcity-server.mydomain.com"
ENV AGENT_NAME="build-agent-1"
</code></pre>
</div>

<p>So we base our docker image from <code class="highlighter-rouge">jetbrains/teamcity-agent</code> then install nodejs as is done in the <a href="https://hub.docker.com/_/node/">official nodejs docker image</a> and finally we install our global npm packages required for the build.</p>

<p>I chose to have a separate RUN command for the global packages as they are changing more often than nodejs version changes and would hate to have to build that whole layer again and again.</p>

<p>All you have to do now is run <code class="highlighter-rouge">docker build -t username/teamcity-agent .</code> in the same directory as the above Dockerfile and you are good to go.</p>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Teamcity agent as Docker container - /posts/teamcity-agent-as-docker-container by @masimplo', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=/posts/teamcity-agent-as-docker-container', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=/posts/teamcity-agent-as-docker-container', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          
        </article>
        <footer class="footer reveal">

</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>


  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-28844594-2','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>